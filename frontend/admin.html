<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用戶管理 - MFP Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .user-card {
            transition: transform 0.2s;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
        }
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .user-type-badge {
            font-size: 0.8rem;
        }
        .btn-action {
            margin: 0 2px;
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-tools"></i> MFP Tool
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html">
                    <i class="fas fa-arrow-left"></i> 返回主頁
                </a>
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> 登出
                </a>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-users-cog"></i> 用戶管理</h1>
                    <p class="mb-0">管理系統用戶帳號</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light btn-lg" onclick="showCreateModal()">
                        <i class="fas fa-user-plus"></i> 新增用戶
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Loading -->
        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>載入中...</p>
        </div>

        <!-- Users Table -->
        <div id="usersContainer" class="mb-4">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>帳號</th>
                            <th>姓名</th>
                            <th>類型</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus"></i> 新增用戶
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createUserForm">
                        <div class="mb-3">
                            <label for="createAccount" class="form-label">帳號</label>
                            <input type="text" class="form-control" id="createAccount" required>
                        </div>
                        <div class="mb-3">
                            <label for="createPassword" class="form-label">密碼</label>
                            <input type="password" class="form-control" id="createPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="createName" class="form-label">姓名</label>
                            <input type="text" class="form-control" id="createName" required>
                        </div>
                        <div class="mb-3">
                            <label for="createType" class="form-label">用戶類型</label>
                            <select class="form-select" id="createType" required>
                                <option value="1">一般用戶</option>
                                <option value="2">管理員</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createUser()">
                        <i class="fas fa-save"></i> 創建
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-edit"></i> 編輯用戶
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label for="editAccount" class="form-label">帳號</label>
                            <input type="text" class="form-control" id="editAccount" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPassword" class="form-label">密碼 (留空表示不修改)</label>
                            <input type="password" class="form-control" id="editPassword">
                        </div>
                        <div class="mb-3">
                            <label for="editName" class="form-label">姓名</label>
                            <input type="text" class="form-control" id="editName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editType" class="form-label">用戶類型</label>
                            <select class="form-select" id="editType" required>
                                <option value="1">一般用戶</option>
                                <option value="2">管理員</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="updateUser()">
                        <i class="fas fa-save"></i> 保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="config.js"></script>
    
    <script>
        let currentUsers = [];
        let createUserModalInstance, editUserModalInstance;

        $(document).ready(function() {
            // Initialize modals
            createUserModalInstance = new bootstrap.Modal(document.getElementById('createUserModal'));
            editUserModalInstance = new bootstrap.Modal(document.getElementById('editUserModal'));
            
            // Check admin permission and load users
            checkAdminPermission();
        });

        function checkAdminPermission() {
            fetch(`${getApiBaseUrl()}/verify-token`, {
                headers: getAuthHeaders()
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Authentication failed');
                }
                return response.json();
            })
            .then(data => {
                if (data.user.type !== 2) {
                    alert('您沒有管理員權限！');
                    window.location.href = 'index.html';
                    return;
                }
                loadUsers();
            })
            .catch(error => {
                console.error('Permission check failed:', error);
                logout();
            });
        }

        function loadUsers() {
            $('#loading').show();
            $('#usersContainer').hide();
            
            fetch(`${getApiBaseUrl()}/admin/users`, {
                headers: getAuthHeaders()
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                currentUsers = data.users;
                displayUsers(data.users);
                $('#loading').hide();
                $('#usersContainer').show();
            })
            .catch(error => {
                console.error('Error loading users:', error);
                $('#loading').hide();
                alert('載入用戶列表失敗');
                if (error.message.includes('401') || error.message.includes('403')) {
                    logout();
                }
            });
        }

        function displayUsers(users) {
            const tbody = $('#usersTableBody');
            tbody.empty();
            
            users.forEach(user => {
                const typeText = user.type === 2 ? '管理員' : '一般用戶';
                const typeBadge = user.type === 2 ? 'badge bg-danger' : 'badge bg-primary';
                
                const row = `
                    <tr>
                        <td>${user.uid}</td>
                        <td>${user.account}</td>
                        <td>${user.name}</td>
                        <td><span class="${typeBadge} user-type-badge">${typeText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary btn-action" onclick="editUser(${user.uid})" title="編輯">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteUser(${user.uid})" title="刪除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function showCreateModal() {
            $('#createUserForm')[0].reset();
            createUserModalInstance.show();
        }

        function createUser() {
            const account = $('#createAccount').val().trim();
            const password = $('#createPassword').val();
            const name = $('#createName').val().trim();
            const type = parseInt($('#createType').val());
            
            if (!account || !password || !name) {
                alert('請填寫所有必填欄位');
                return;
            }
            
            const userData = {
                account: account,
                password: password,
                name: name,
                type: type
            };
            
            fetch(`${getApiBaseUrl()}/admin/users`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(userData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.detail || 'Create user failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert('用戶創建成功！');
                createUserModalInstance.hide();
                loadUsers();
            })
            .catch(error => {
                console.error('Error creating user:', error);
                alert(`創建用戶失敗: ${error.message}`);
            });
        }

        function editUser(userId) {
            const user = currentUsers.find(u => u.uid === userId);
            if (!user) {
                alert('找不到用戶資料');
                return;
            }
            
            $('#editUserId').val(user.uid);
            $('#editAccount').val(user.account);
            $('#editPassword').val(''); // Clear password field
            $('#editName').val(user.name);
            $('#editType').val(user.type);
            
            editUserModalInstance.show();
        }

        function updateUser() {
            const userId = $('#editUserId').val();
            const account = $('#editAccount').val().trim();
            const password = $('#editPassword').val();
            const name = $('#editName').val().trim();
            const type = parseInt($('#editType').val());
            
            if (!account || !name) {
                alert('請填寫所有必填欄位');
                return;
            }
            
            const userData = {
                account: account,
                name: name,
                type: type
            };
            
            // Only include password if it's provided
            if (password) {
                userData.password = password;
            }
            
            fetch(`${getApiBaseUrl()}/admin/users/${userId}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(userData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.detail || 'Update user failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert('用戶更新成功！');
                editUserModalInstance.hide();
                loadUsers();
            })
            .catch(error => {
                console.error('Error updating user:', error);
                alert(`更新用戶失敗: ${error.message}`);
            });
        }

        function deleteUser(userId) {
            const user = currentUsers.find(u => u.uid === userId);
            if (!user) {
                alert('找不到用戶資料');
                return;
            }
            
            if (!confirm(`確定要刪除用戶 "${user.account}" 嗎？此操作不可撤銷。`)) {
                return;
            }
            
            fetch(`${getApiBaseUrl()}/admin/users/${userId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.detail || 'Delete user failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert('用戶刪除成功！');
                loadUsers();
            })
            .catch(error => {
                console.error('Error deleting user:', error);
                alert(`刪除用戶失敗: ${error.message}`);
            });
        }
    </script>
</body>
</html>
