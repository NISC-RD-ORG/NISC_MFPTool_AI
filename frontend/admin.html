<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工具管理 - MFP Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .user-card {
            transition: transform 0.2s;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
        }
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .user-type-badge {
            font-size: 0.8rem;
        }
        .btn-action {
            margin: 0 2px;
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tool-card {
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
        }
        .tool-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .tool-card.category-card {
            background-color: #FFF3CD;
            border-color: #ffeaa7;
        }
        .tool-card.tool-item-card {
            background-color: #D4EDDA;
            border-color: #c3e6cb;
        }
        .nav-tabs .nav-link {
            color: #495057;
            border: none;
            border-bottom: 2px solid transparent;
        }
        .nav-tabs .nav-link.active {
            color: #764ba2;
            border-bottom: 2px solid #764ba2;
            background: none;
        }
        .nav-tabs .nav-link:hover {
            border-bottom: 2px solid #667eea;
        }
        .breadcrumb {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 0.75rem 1rem;
        }
        .breadcrumb-item a {
            color: #667eea;
            text-decoration: none;
        }
        .breadcrumb-item a:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        /* Tool Editor Styles */
        #editToolModal .modal-content {
            height: 100vh;
        }
        #editToolModal .modal-body {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        #editToolModal textarea {
            font-family: 'Courier New', 'Consolas', monospace;
            tab-size: 4;
            -webkit-tab-size: 4;
            -moz-tab-size: 4;
        }
        #editToolPreview {
            background-color: #f8f9fa;
            line-height: 1.6;
        }
        #editToolPreview h1, #editToolPreview h2, #editToolPreview h3, #editToolPreview h4, #editToolPreview h5, #editToolPreview h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        #editToolPreview h1:first-child, #editToolPreview h2:first-child, #editToolPreview h3:first-child {
            margin-top: 0;
        }
        #editToolPreview img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 10px 0;
        }
        #editToolPreview pre {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 13px;
        }
        #editToolPreview code {
            background-color: #e2e8f0;
            color: #2d3748;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 13px;
        }
        #editToolPreview pre code {
            background: none;
            color: inherit;
            padding: 0;
        }
        #editToolPreview blockquote {
            border-left: 4px solid #667eea;
            margin: 1em 0;
            padding: 0.5em 1em;
            background-color: #f0f4f8;
            color: #2d3748;
        }
        #editToolPreview table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }
        #editToolPreview table th,
        #editToolPreview table td {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            text-align: left;
        }
        #editToolPreview table th {
            background-color: #667eea;
            color: white;
            font-weight: bold;
        }
        .edit-sync-scroll {
            overflow: hidden;
        }
        /* Image Management Styles */
        .image-item {
            position: relative;
            display: inline-block;
            margin: 3px;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
            background: white;
        }
        .image-item img {
            width: 80px;
            height: 60px;
            object-fit: cover;
            display: block;
        }
        .image-item .image-actions {
            position: absolute;
            top: 3px;
            right: 3px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .image-item:hover .image-actions {
            opacity: 1;
        }
        .image-item .image-name {
            padding: 3px;
            font-size: 10px;
            text-align: center;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            word-break: break-all;
        }
        .image-upload-progress {
            display: none;
            margin-top: 10px;
        }
        .image-upload-progress .progress {
            height: 5px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-tools"></i> MFP Tool
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html">
                    <i class="fas fa-arrow-left"></i> 返回主頁
                </a>
                <a class="nav-link" href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> 登出
                </a>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-users-cog"></i> 系統管理</h1>
                    <p class="mb-0">管理系統用戶帳號和工具內容</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tools-tab" data-bs-toggle="tab" data-bs-target="#tools" type="button" role="tab">
                    <i class="fas fa-tools"></i> 工具管理
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                    <i class="fas fa-users"></i> 用戶管理
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="adminTabContent">
        <!-- Tab Content -->
        <div class="tab-content" id="adminTabContent">
            <!-- Users Management Tab -->
            <div class="tab-pane fade" id="users" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3><i class="fas fa-users"></i> 用戶管理</h3>
                    <button class="btn btn-primary" onclick="showCreateModal()">
                        <i class="fas fa-user-plus"></i> 新增用戶
                    </button>
                </div>
                
                <!-- Loading -->
                <div id="loading" class="loading">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>載入中...</p>
                </div>

                <!-- Users Table -->
                <div id="usersContainer" class="mb-4">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>帳號</th>
                                    <th>姓名</th>
                                    <th>類型</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tools Management Tab -->
            <div class="tab-pane fade show active" id="tools" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3><i class="fas fa-tools"></i> 工具管理</h3>
                    <div>
                        <div class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-plus"></i> 新增
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="showCreateCategoryModal()">
                                    <i class="fas fa-folder-plus"></i> 新增分類
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="showCreateToolModal()">
                                    <i class="fas fa-file-plus"></i> 新增工具
                                </a></li>
                            </ul>
                        </div>
                        <button class="btn btn-info me-2" onclick="refreshToolsList()">
                            <i class="fas fa-sync-alt"></i> 重新整理
                        </button>
                    </div>
                </div>

                <!-- Tools Navigation -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb" id="toolsBreadcrumb">
                                <li class="breadcrumb-item active">根目錄</li>
                            </ol>
                        </nav>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="toolsSearch" placeholder="搜尋工具...">
                            <button class="btn btn-outline-secondary" onclick="searchTools()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tools Loading -->
                <div id="toolsLoading" class="loading">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>載入中...</p>
                </div>

                <!-- Tools Content -->
                <div id="toolsContainer">
                    <div class="row" id="toolsGrid">
                        <!-- Tools and categories will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus"></i> 新增用戶
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createUserForm">
                        <div class="mb-3">
                            <label for="createAccount" class="form-label">帳號</label>
                            <input type="text" class="form-control" id="createAccount" required>
                        </div>
                        <div class="mb-3">
                            <label for="createPassword" class="form-label">密碼</label>
                            <input type="password" class="form-control" id="createPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="createPasswordConfirm" class="form-label">確認密碼</label>
                            <input type="password" class="form-control" id="createPasswordConfirm" required>
                            <div class="invalid-feedback" id="createPasswordError"></div>
                        </div>
                        <div class="mb-3">
                            <label for="createName" class="form-label">姓名</label>
                            <input type="text" class="form-control" id="createName" required>
                        </div>
                        <div class="mb-3">
                            <label for="createType" class="form-label">用戶類型</label>
                            <select class="form-select" id="createType" required>
                                <option value="1">一般用戶</option>
                                <option value="2">管理員</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createUser()">
                        <i class="fas fa-save"></i> 創建
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-edit"></i> 編輯用戶
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label for="editAccount" class="form-label">帳號</label>
                            <input type="text" class="form-control" id="editAccount" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPassword" class="form-label">密碼 (留空表示不修改)</label>
                            <input type="password" class="form-control" id="editPassword">
                        </div>
                        <div class="mb-3">
                            <label for="editPasswordConfirm" class="form-label">確認密碼</label>
                            <input type="password" class="form-control" id="editPasswordConfirm">
                            <div class="invalid-feedback" id="editPasswordError"></div>
                        </div>
                        <div class="mb-3">
                            <label for="editName" class="form-label">姓名</label>
                            <input type="text" class="form-control" id="editName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editType" class="form-label">用戶類型</label>
                            <select class="form-select" id="editType" required>
                                <option value="1">一般用戶</option>
                                <option value="2">管理員</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="updateUser()">
                        <i class="fas fa-save"></i> 保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Tool Modal -->
    <div class="modal fade" id="editToolModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit"></i> 編輯工具內容
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="row h-100 g-0">
                        <!-- Edit Panel -->
                        <div class="col-md-5 border-end d-flex flex-column">
                            <div class="p-3 border-bottom">
                                <div class="d-flex gap-2 align-items-center">
                                    <button class="btn btn-success btn-sm" id="saveToolBtn" onclick="saveToolContent()">
                                        <i class="fas fa-save"></i> 儲存
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="cancelToolEdit()">
                                        <i class="fas fa-times"></i> 取消
                                    </button>
                                    <div class="ms-auto d-flex align-items-center gap-3">
                                        <small class="text-muted">
                                            <span id="charCount">0</span> 字符 | 
                                            <span id="lineCount">1</span> 行
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-grow-1 position-relative">
                                <textarea class="form-control border-0 h-100 position-absolute w-100" 
                                    id="editToolTextarea" 
                                    placeholder="在此編輯 Markdown 內容..." 
                                    style="font-family: 'Courier New', monospace; font-size: 14px; resize: none; top: 0; left: 0; padding: 20px; line-height: 1.5;"></textarea>
                            </div>
                        </div>
                        <!-- Preview Panel -->
                        <div class="col-md-5 border-end d-flex flex-column">
                            <div class="p-3 border-bottom">
                                <h6 class="mb-0"><i class="fas fa-eye"></i> 即時預覽</h6>
                            </div>
                            <div class="flex-grow-1 overflow-auto position-relative" id="editToolPreviewContainer">
                                <div id="editToolPreview" class="p-3" style="min-height: 100%;">
                                    預覽內容將在此顯示...
                                </div>
                            </div>
                        </div>
                        <!-- Image Management Panel -->
                        <div class="col-md-2 d-flex flex-column">
                            <div class="p-2 border-bottom">
                                <h6 class="mb-0 small"><i class="fas fa-images"></i> 圖片</h6>
                            </div>
                            <div class="flex-grow-1 overflow-auto">
                                <!-- Image Upload Area -->
                                <div class="p-2 border-bottom">
                                    <div class="mb-2">
                                        <label for="imageUpload" class="form-label small">上傳圖片</label>
                                        <input type="file" class="form-control form-control-sm" id="imageUpload" multiple accept="image/*">
                                        <div class="form-text small">支援 JPG, PNG, GIF</div>
                                    </div>
                                    <button class="btn btn-primary btn-sm w-100" onclick="uploadImages()">
                                        <i class="fas fa-upload"></i> 上傳
                                    </button>
                                    <!-- Upload Progress -->
                                    <div class="image-upload-progress mt-2">
                                        <div class="d-flex justify-content-between mb-1">
                                            <small class="text-muted">上傳進度</small>
                                            <small class="text-muted">0%</small>
                                        </div>
                                        <div class="progress">
                                            <div class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Existing Images -->
                                <div class="p-2">
                                    <h6 class="small">現有圖片</h6>
                                    <div id="existingImages" class="mt-2">
                                        <div class="text-muted text-center py-3">
                                            <i class="fas fa-image fa-2x mb-2"></i>
                                            <p class="small">載入中...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Metadata Modal -->
    <div class="modal fade" id="editMetadataModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-cog"></i> 編輯工具屬性 (metadata.json)
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="d-flex gap-2 align-items-center mb-2">
                            <button class="btn btn-outline-secondary btn-sm" onclick="formatMetadata()">
                                <i class="fas fa-indent"></i> 格式化
                            </button>
                            <div class="ms-auto">
                                <small class="text-muted">Ctrl+S 儲存 | Esc 取消</small>
                            </div>
                        </div>
                        <textarea class="form-control" id="editMetadataTextarea" 
                            placeholder="請輸入 JSON 格式的 metadata..." 
                            style="font-family: 'Courier New', monospace; font-size: 14px; min-height: 400px;"></textarea>
                        <div id="metadataValidation" class="mt-2"></div>
                        <div class="form-text">
                            <strong>常用欄位說明：</strong><br>
                            • <code>display_name</code>: 顯示名稱<br>
                            • <code>description</code>: 工具描述<br>
                            • <code>category</code>: 分類<br>
                            • <code>tags</code>: 標籤 (陣列)<br>
                            • <code>version</code>: 版本<br>
                            • <code>last_modified</code>: 最後修改時間
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cancelMetadataEdit()">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveMetadata()">
                        <i class="fas fa-save"></i> 儲存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Category Modal -->
    <div class="modal fade" id="createCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-folder-plus"></i> 新增分類
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createCategoryForm">
                        <div class="mb-3">
                            <label for="categoryPath" class="form-label">當前位置</label>
                            <input type="text" class="form-control" id="categoryPath" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">分類名稱</label>
                            <input type="text" class="form-control" id="categoryName" placeholder="請輸入分類名稱" required>
                            <div class="form-text">分類名稱將作為資料夾名稱，建議使用英文或數字</div>
                        </div>
                        <div class="mb-3">
                            <label for="categoryDisplayName" class="form-label">顯示名稱</label>
                            <input type="text" class="form-control" id="categoryDisplayName" placeholder="請輸入顯示名稱">
                            <div class="form-text">顯示名稱可以使用中文，將顯示在介面上</div>
                        </div>
                        <div class="mb-3">
                            <label for="categoryDescription" class="form-label">描述 (選填)</label>
                            <textarea class="form-control" id="categoryDescription" rows="3" placeholder="請輸入分類描述"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createCategory()">
                        <i class="fas fa-save"></i> 創建
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Tool Modal -->
    <div class="modal fade" id="createToolModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-file-plus"></i> 新增工具
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createToolForm">
                        <div class="mb-3">
                            <label for="toolPath" class="form-label">當前位置</label>
                            <input type="text" class="form-control" id="toolPath" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="toolName" class="form-label">工具名稱</label>
                            <input type="text" class="form-control" id="toolName" placeholder="請輸入工具名稱" required>
                            <div class="form-text">工具名稱將作為資料夾名稱，建議使用英文或數字</div>
                        </div>
                        <div class="mb-3">
                            <label for="toolDisplayName" class="form-label">顯示名稱</label>
                            <input type="text" class="form-control" id="toolDisplayName" placeholder="請輸入顯示名稱" required>
                            <div class="form-text">顯示名稱可以使用中文，將顯示在介面上</div>
                        </div>
                        <div class="mb-3">
                            <label for="toolDescription" class="form-label">工具描述</label>
                            <textarea class="form-control" id="toolDescription" rows="3" placeholder="請輸入工具描述" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="toolCategory" class="form-label">分類</label>
                            <input type="text" class="form-control" id="toolCategory" placeholder="請輸入分類標籤">
                            <div class="form-text">例如：維修、保養、故障排除等</div>
                        </div>
                        <div class="mb-3">
                            <label for="toolTags" class="form-label">標籤 (選填)</label>
                            <input type="text" class="form-control" id="toolTags" placeholder="請輸入標籤，用逗號分隔">
                            <div class="form-text">例如：步驟,操作手冊,檢修</div>
                        </div>
                        <div class="mb-3">
                            <label for="toolContent" class="form-label">內容</label>
                            <textarea class="form-control" id="toolContent" rows="10" 
                                placeholder="請輸入工具內容 (支援 Markdown 格式)&#10;&#10;例如：&#10;# 工具標題&#10;&#10;## 步驟1&#10;1. 執行...&#10;2. 檢查...&#10;&#10;## 步驟2&#10;![圖片說明](./image/example.png)"
                                style="font-family: 'Courier New', monospace;"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createTool()">
                        <i class="fas fa-save"></i> 創建
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="config.js"></script>
    
    <script>
        let currentUsers = [];
        let createUserModalInstance, editUserModalInstance, editToolModalInstance, editMetadataModalInstance, createCategoryModalInstance, createToolModalInstance;
        
        // Tool editing variables
        let currentEditingToolPath = '';
        let currentEditingToolContent = '';
        let hasUnsavedChanges = false;

        // Metadata editing variables
        let currentEditingMetadataPath = '';
        let currentEditingMetadataContent = '';
        let hasUnsavedMetadataChanges = false;

        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        $(document).ready(function() {
            // Initialize modals
            createUserModalInstance = new bootstrap.Modal(document.getElementById('createUserModal'));
            editUserModalInstance = new bootstrap.Modal(document.getElementById('editUserModal'));
            editToolModalInstance = new bootstrap.Modal(document.getElementById('editToolModal'));
            editMetadataModalInstance = new bootstrap.Modal(document.getElementById('editMetadataModal'));
            createCategoryModalInstance = new bootstrap.Modal(document.getElementById('createCategoryModal'));
            createToolModalInstance = new bootstrap.Modal(document.getElementById('createToolModal'));
            
            // Password validation for create form
            $('#createPassword, #createPasswordConfirm').on('input', function() {
                validateCreatePassword();
            });
            
            // Password validation for edit form
            $('#editPassword, #editPasswordConfirm').on('input', function() {
                validateEditPassword();
            });
            
            // Check admin permission and load users
            checkAdminPermission();
        });

        function checkAdminPermission() {
            fetch(`${getApiBaseUrl()}/verify-token`, {
                headers: getAuthHeaders()
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Authentication failed');
                }
                return response.json();
            })
            .then(data => {
                if (data.user.type !== 2) {
                    alert('您沒有管理員權限！');
                    window.location.href = 'index.html';
                    return;
                }
                loadUsers();
            })
            .catch(error => {
                console.error('Permission check failed:', error);
                logout();
            });
        }

        function loadUsers() {
            $('#loading').show();
            $('#usersContainer').hide();
            
            fetch(`${getApiBaseUrl()}/admin/users`, {
                headers: getAuthHeaders()
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                currentUsers = data.users;
                displayUsers(data.users);
                $('#loading').hide();
                $('#usersContainer').show();
            })
            .catch(error => {
                console.error('Error loading users:', error);
                $('#loading').hide();
                alert('載入用戶列表失敗');
                if (error.message.includes('401') || error.message.includes('403')) {
                    logout();
                }
            });
        }

        function displayUsers(users) {
            const tbody = $('#usersTableBody');
            tbody.empty();
            
            users.forEach(user => {
                const typeText = user.type === 2 ? '管理員' : '一般用戶';
                const typeBadge = user.type === 2 ? 'badge bg-danger' : 'badge bg-primary';
                
                const row = `
                    <tr>
                        <td>${user.uid}</td>
                        <td>${user.account}</td>
                        <td>${user.name}</td>
                        <td><span class="${typeBadge} user-type-badge">${typeText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary btn-action" onclick="editUser(${user.uid})" title="編輯">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteUser(${user.uid})" title="刪除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function showCreateModal() {
            $('#createUserForm')[0].reset();
            // Reset validation states
            $('#createPassword, #createPasswordConfirm').removeClass('is-invalid is-valid');
            $('#createPasswordError').text('');
            createUserModalInstance.show();
        }

        function createUser() {
            const account = $('#createAccount').val().trim();
            const password = $('#createPassword').val();
            const passwordConfirm = $('#createPasswordConfirm').val();
            const name = $('#createName').val().trim();
            const type = parseInt($('#createType').val());
            
            // Reset validation states
            $('#createPassword, #createPasswordConfirm').removeClass('is-invalid');
            $('#createPasswordError').text('');
            
            if (!account || !password || !name) {
                alert('請填寫所有必填欄位');
                return;
            }
            
            // Validate password confirmation
            if (password !== passwordConfirm) {
                $('#createPassword, #createPasswordConfirm').addClass('is-invalid');
                $('#createPasswordError').text('密碼和確認密碼不匹配');
                return;
            }
            
            if (password.length < 6) {
                $('#createPassword, #createPasswordConfirm').addClass('is-invalid');
                $('#createPasswordError').text('密碼長度至少需要6個字符');
                return;
            }
            
            const userData = {
                account: account,
                password: password,
                name: name,
                type: type
            };
            
            fetch(`${getApiBaseUrl()}/admin/users`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(userData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.detail || 'Create user failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert('用戶創建成功！');
                createUserModalInstance.hide();
                loadUsers();
            })
            .catch(error => {
                console.error('Error creating user:', error);
                alert(`創建用戶失敗: ${error.message}`);
            });
        }

        function editUser(userId) {
            const user = currentUsers.find(u => u.uid === userId);
            if (!user) {
                alert('找不到用戶資料');
                return;
            }
            
            $('#editUserId').val(user.uid);
            $('#editAccount').val(user.account);
            $('#editPassword').val(''); // Clear password field
            $('#editPasswordConfirm').val(''); // Clear password confirmation field
            $('#editName').val(user.name);
            $('#editType').val(user.type);
            
            // Reset validation states
            $('#editPassword, #editPasswordConfirm').removeClass('is-invalid is-valid');
            $('#editPasswordError').text('');
            
            editUserModalInstance.show();
        }

        function updateUser() {
            const userId = $('#editUserId').val();
            const account = $('#editAccount').val().trim();
            const password = $('#editPassword').val();
            const passwordConfirm = $('#editPasswordConfirm').val();
            const name = $('#editName').val().trim();
            const type = parseInt($('#editType').val());
            
            // Reset validation states
            $('#editPassword, #editPasswordConfirm').removeClass('is-invalid');
            $('#editPasswordError').text('');
            
            if (!account || !name) {
                alert('請填寫所有必填欄位');
                return;
            }
            
            // Validate password confirmation if password is provided
            if (password || passwordConfirm) {
                if (password !== passwordConfirm) {
                    $('#editPassword, #editPasswordConfirm').addClass('is-invalid');
                    $('#editPasswordError').text('密碼和確認密碼不匹配');
                    return;
                }
                
                if (password.length < 6) {
                    $('#editPassword, #editPasswordConfirm').addClass('is-invalid');
                    $('#editPasswordError').text('密碼長度至少需要6個字符');
                    return;
                }
            }
            
            const userData = {
                account: account,
                name: name,
                type: type
            };
            
            // Only include password if it's provided
            if (password) {
                userData.password = password;
            }
            
            fetch(`${getApiBaseUrl()}/admin/users/${userId}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(userData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.detail || 'Update user failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert('用戶更新成功！');
                editUserModalInstance.hide();
                loadUsers();
            })
            .catch(error => {
                console.error('Error updating user:', error);
                alert(`更新用戶失敗: ${error.message}`);
            });
        }

        function deleteUser(userId) {
            const user = currentUsers.find(u => u.uid === userId);
            if (!user) {
                alert('找不到用戶資料');
                return;
            }
            
            if (!confirm(`確定要刪除用戶 "${user.account}" 嗎？此操作不可撤銷。`)) {
                return;
            }
            
            fetch(`${getApiBaseUrl()}/admin/users/${userId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.detail || 'Delete user failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert('用戶刪除成功！');
                loadUsers();
            })
            .catch(error => {
                console.error('Error deleting user:', error);
                alert(`刪除用戶失敗: ${error.message}`);
            });
        }

        function validateCreatePassword() {
            const password = $('#createPassword').val();
            const passwordConfirm = $('#createPasswordConfirm').val();
            
            // Reset validation states
            $('#createPassword, #createPasswordConfirm').removeClass('is-invalid is-valid');
            $('#createPasswordError').text('');
            
            if (password || passwordConfirm) {
                if (password.length > 0 && password.length < 6) {
                    $('#createPassword').addClass('is-invalid');
                    $('#createPasswordError').text('密碼長度至少需要6個字符');
                } else if (password.length >= 6) {
                    $('#createPassword').addClass('is-valid');
                }
                
                if (passwordConfirm.length > 0) {
                    if (password === passwordConfirm && password.length >= 6) {
                        $('#createPasswordConfirm').addClass('is-valid');
                    } else if (password !== passwordConfirm) {
                        $('#createPasswordConfirm').addClass('is-invalid');
                        $('#createPasswordError').text('密碼和確認密碼不匹配');
                    }
                }
            }
        }

        // ========== 新增功能 ==========
        function showCreateCategoryModal() {
            $('#createCategoryForm')[0].reset();
            $('#categoryPath').val(currentToolsPath || '根目錄');
            createCategoryModalInstance.show();
        }

        function showCreateToolModal() {
            $('#createToolForm')[0].reset();
            $('#toolPath').val(currentToolsPath || '根目錄');
            createToolModalInstance.show();
        }

        function createCategory() {
            const name = $('#categoryName').val().trim();
            const displayName = $('#categoryDisplayName').val().trim();
            const description = $('#categoryDescription').val().trim();
            
            if (!name) {
                alert('請輸入分類名稱');
                return;
            }
            
            const categoryData = {
                name: name,
                display_name: displayName || name,
                description: description,
                parent_path: currentToolsPath
            };
            
            fetch(`${getApiBaseUrl()}/admin/categories`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(categoryData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.detail || 'Create category failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert('分類創建成功！');
                createCategoryModalInstance.hide();
                refreshToolsList();
            })
            .catch(error => {
                console.error('Error creating category:', error);
                alert(`創建分類失敗: ${error.message}`);
            });
        }

        function createTool() {
            const name = $('#toolName').val().trim();
            const displayName = $('#toolDisplayName').val().trim();
            const description = $('#toolDescription').val().trim();
            const category = $('#toolCategory').val().trim();
            const tagsText = $('#toolTags').val().trim();
            const content = $('#toolContent').val().trim();
            
            if (!name || !displayName || !description || !content) {
                alert('請填寫所有必填欄位');
                return;
            }
            
            // Parse tags
            const tags = tagsText ? tagsText.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
            
            const toolData = {
                name: name,
                display_name: displayName,
                description: description,
                category: category,
                tags: tags,
                content: content,
                parent_path: currentToolsPath
            };
            
            fetch(`${getApiBaseUrl()}/admin/tools`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(toolData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.detail || 'Create tool failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert('工具創建成功！');
                createToolModalInstance.hide();
                refreshToolsList();
            })
            .catch(error => {
                console.error('Error creating tool:', error);
                alert(`創建工具失敗: ${error.message}`);
            });
        }

        // ========== 工具管理功能 ==========
        let currentToolsPath = '';
        let currentToolsList = [];

        function refreshToolsList() {
            loadToolsData(currentToolsPath);
        }

        function loadToolsData(path = '') {
            $('#toolsLoading').show();
            $('#toolsContainer').hide();
            
            fetch(`${getApiBaseUrl()}/browse?path=${encodeURIComponent(path)}`, {
                headers: getAuthHeaders()
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load tools');
                }
                return response.json();
            })
            .then(data => {
                currentToolsPath = path;
                currentToolsList = data.items || [];
                displayToolsData(data);
                updateToolsBreadcrumb(data.breadcrumbs || [], data.parent_path);
                $('#toolsLoading').hide();
                $('#toolsContainer').show();
            })
            .catch(error => {
                console.error('Error loading tools:', error);
                alert('載入工具清單失敗');
                $('#toolsLoading').hide();
            });
        }

        function displayToolsData(data) {
            const grid = $('#toolsGrid');
            grid.empty();

            if (!data.items || data.items.length === 0) {
                grid.html(`
                    <div class="col-12">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-folder-open fa-3x mb-3"></i>
                            <h5>此目錄為空</h5>
                            <p>沒有找到任何工具或子分類</p>
                        </div>
                    </div>
                `);
                return;
            }

            data.items.forEach(item => {
                const card = createToolCard(item);
                grid.append(card);
            });
        }

        function createToolCard(item) {
            const isCategory = !item.is_tool;
            const icon = isCategory ? 'fas fa-folder' : 'fas fa-file-alt';
            const badgeClass = isCategory ? 'bg-info' : 'bg-success';
            const badgeText = isCategory ? `${item.tool_count || 0} 工具` : '工具';
            const cardTypeClass = isCategory ? 'category-card' : 'tool-item-card';
            
            return $(`
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card tool-card ${cardTypeClass} h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-start justify-content-between">
                                <div class="flex-grow-1">
                                    <h6 class="card-title">
                                        <i class="${icon} me-2"></i>
                                        ${escapeHtml(item.display_name)}
                                    </h6>
                                    <small class="text-muted">${escapeHtml(item.name)}</small>
                                </div>
                                <span class="badge ${badgeClass} ms-2">${badgeText}</span>
                            </div>
                            <div class="mt-3">
                                ${isCategory ? 
                                    `<button class="btn btn-sm btn-outline-primary me-1" onclick="navigateToPath('${item.path}')">
                                        <i class="fas fa-folder-open"></i> 開啟
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="checkDeleteCategory('${item.path}')">
                                        <i class="fas fa-trash"></i> 刪除
                                    </button>` :
                                    `<button class="btn btn-sm btn-outline-primary me-1" onclick="editTool('${item.path}')">
                                        <i class="fas fa-edit"></i> 編輯
                                    </button>
                                    <button class="btn btn-sm btn-outline-info me-1" onclick="editMetadata('${item.path}')">
                                        <i class="fas fa-cog"></i> 屬性
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTool('${item.path}')">
                                        <i class="fas fa-trash"></i> 刪除
                                    </button>`
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }

        function updateToolsBreadcrumb(breadcrumbs, parentPath) {
            const breadcrumbContainer = $('#toolsBreadcrumb');
            breadcrumbContainer.empty();

            // Root breadcrumb
            breadcrumbContainer.append(`
                <li class="breadcrumb-item">
                    <a href="#" onclick="navigateToPath('')">根目錄</a>
                </li>
            `);

            // Add breadcrumbs
            breadcrumbs.forEach((crumb, index) => {
                if (index === breadcrumbs.length - 1) {
                    breadcrumbContainer.append(`
                        <li class="breadcrumb-item active">${escapeHtml(crumb.display_name)}</li>
                    `);
                } else {
                    breadcrumbContainer.append(`
                        <li class="breadcrumb-item">
                            <a href="#" onclick="navigateToPath('${crumb.path}')">${escapeHtml(crumb.display_name)}</a>
                        </li>
                    `);
                }
            });
        }

        function navigateToPath(path) {
            loadToolsData(path);
        }

        // Metadata editing function
        function editMetadata(toolPath) {
            currentEditingMetadataPath = toolPath;
            const metadataPath = toolPath + '/metadata.json';
            
            // Fetch current metadata
            fetch(`${getApiBaseUrl()}/api/get-file`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    file_path: metadataPath
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show info if default metadata was created
                    if (data.created_default) {
                        alert('metadata.json 不存在，已創建預設模板。請編輯後儲存。');
                    }
                    
                    // Parse and format JSON for better readability
                    try {
                        const jsonObject = JSON.parse(data.content);
                        const formattedJson = JSON.stringify(jsonObject, null, 2);
                        document.getElementById('editMetadataTextarea').value = formattedJson;
                        hasUnsavedMetadataChanges = data.created_default || false; // Mark as changed if default was created
                        updateMetadataUI();
                    } catch (e) {
                        // If JSON is invalid, show raw content
                        document.getElementById('editMetadataTextarea').value = data.content;
                        document.getElementById('metadataValidation').innerHTML = '<div class="text-danger">⚠️ 無效的JSON格式</div>';
                    }
                    editMetadataModalInstance.show();
                } else {
                    alert('讀取metadata.json失敗: ' + (data.error || '未知錯誤'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('讀取metadata.json時發生錯誤: ' + error.message);
            });
        }

        // Save metadata
        function saveMetadata() {
            const content = document.getElementById('editMetadataTextarea').value;
            
            // Validate JSON format
            try {
                JSON.parse(content);
            } catch (e) {
                alert('JSON格式錯誤，無法儲存: ' + e.message);
                return;
            }
            
            const metadataPath = currentEditingMetadataPath + '/metadata.json';
            
            fetch(`${getApiBaseUrl()}/api/save-file`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    file_path: metadataPath,
                    content: content
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    hasUnsavedMetadataChanges = false;
                    updateMetadataUI();
                    editMetadataModalInstance.hide();
                    alert('metadata.json已成功儲存');
                } else {
                    alert('儲存失敗: ' + (data.error || '未知錯誤'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('儲存時發生錯誤: ' + error.message);
            });
        }

        // Update metadata UI
        function updateMetadataUI() {
            const content = document.getElementById('editMetadataTextarea').value;
            const validationDiv = document.getElementById('metadataValidation');
            const saveButton = document.querySelector('#editMetadataModal .btn-primary');
            
            // Validate JSON
            try {
                JSON.parse(content);
                validationDiv.innerHTML = '<div class="text-success">✅ JSON格式正確</div>';
                saveButton.disabled = false;
            } catch (e) {
                validationDiv.innerHTML = '<div class="text-danger">❌ JSON格式錯誤: ' + e.message + '</div>';
                saveButton.disabled = true;
            }
            
            // Update save button text based on changes
            if (hasUnsavedMetadataChanges) {
                saveButton.textContent = '* 儲存';
            } else {
                saveButton.textContent = '儲存';
            }
        }

        // Cancel metadata editing
        function cancelMetadataEdit() {
            if (hasUnsavedMetadataChanges) {
                if (confirm('有未儲存的變更，確定要取消嗎？')) {
                    editMetadataModalInstance.hide();
                }
            } else {
                editMetadataModalInstance.hide();
            }
        }

        // Format metadata JSON
        function formatMetadata() {
            const content = document.getElementById('editMetadataTextarea').value;
            try {
                const parsed = JSON.parse(content);
                const formatted = JSON.stringify(parsed, null, 2);
                document.getElementById('editMetadataTextarea').value = formatted;
                hasUnsavedMetadataChanges = true;
                updateMetadataUI();
            } catch (e) {
                alert('無法格式化：JSON格式錯誤 - ' + e.message);
            }
        }

        function searchTools() {
            const query = $('#toolsSearch').val().trim();
            if (!query) {
                alert('請輸入搜尋關鍵字');
                return;
            }

            $('#toolsLoading').show();
            $('#toolsContainer').hide();

            fetch(`${getApiBaseUrl()}/search?q=${encodeURIComponent(query)}`, {
                headers: getAuthHeaders()
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Search failed');
                }
                return response.json();
            })
            .then(data => {
                displaySearchResults(data.results || [], query);
                $('#toolsLoading').hide();
                $('#toolsContainer').show();
            })
            .catch(error => {
                console.error('Error searching tools:', error);
                alert('搜尋失敗');
                $('#toolsLoading').hide();
            });
        }

        function displaySearchResults(results, query) {
            const grid = $('#toolsGrid');
            grid.empty();

            // Update breadcrumb to show search
            $('#toolsBreadcrumb').html(`
                <li class="breadcrumb-item">
                    <a href="#" onclick="navigateToPath('')">根目錄</a>
                </li>
                <li class="breadcrumb-item active">搜尋結果: "${escapeHtml(query)}"</li>
            `);

            if (results.length === 0) {
                grid.html(`
                    <div class="col-12">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-search fa-3x mb-3"></i>
                            <h5>沒有找到相關工具</h5>
                            <p>請嘗試其他關鍵字</p>
                            <button class="btn btn-primary" onclick="navigateToPath('')">返回瀏覽</button>
                        </div>
                    </div>
                `);
                return;
            }

            results.forEach(result => {
                const card = $(`
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card tool-card tool-item-card h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="flex-grow-1">
                                        <h6 class="card-title">
                                            <i class="fas fa-file-alt me-2"></i>
                                            ${escapeHtml(result.display_name)}
                                        </h6>
                                        <small class="text-muted">${escapeHtml(result.path_display)}</small>
                                        <br><small class="text-info">匹配類型: ${result.match_type === 'name' ? '名稱' : '內容'}</small>
                                    </div>
                                    <span class="badge bg-success ms-2">工具</span>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editTool('${result.path}')">
                                        <i class="fas fa-edit"></i> 編輯
                                    </button>
                                    <button class="btn btn-sm btn-outline-info me-1" onclick="editMetadata('${result.path}')">
                                        <i class="fas fa-cog"></i> 屬性
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTool('${result.path}')">
                                        <i class="fas fa-trash"></i> 刪除
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
                grid.append(card);
            });
        }

        function deleteTool(toolPath) {
            if (!confirm(`確定要刪除工具 "${toolPath}" 嗎？此操作不可撤銷，但會保留備份。`)) {
                return;
            }

            fetch(`${getApiBaseUrl()}/admin/tools/${encodeURIComponent(toolPath)}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.detail || 'Delete tool failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert('工具刪除成功！備份已保存至: ' + data.backup_location);
                refreshToolsList();
            })
            .catch(error => {
                console.error('Error deleting tool:', error);
                alert(`刪除工具失敗: ${error.message}`);
            });
        }

        function checkDeleteCategory(categoryPath) {
            // First get category info to check if it's empty
            fetch(`${getApiBaseUrl()}/admin/category-info/${encodeURIComponent(categoryPath)}`, {
                headers: getAuthHeaders()
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to get category info');
                }
                return response.json();
            })
            .then(data => {
                if (!data.can_delete) {
                    alert(`無法刪除分類 "${categoryPath}"：\n` +
                          `該分類包含 ${data.tool_count} 個工具和 ${data.subcategory_count} 個子分類。\n` +
                          `請先刪除所有內容再嘗試刪除分類。`);
                    return;
                }

                // Category is empty, confirm deletion
                if (confirm(`確定要刪除空分類 "${categoryPath}" 嗎？此操作不可撤銷，但會保留備份。`)) {
                    deleteCategory(categoryPath);
                }
            })
            .catch(error => {
                console.error('Error checking category:', error);
                alert(`檢查分類狀態失敗: ${error.message}`);
            });
        }

        function deleteCategory(categoryPath) {
            fetch(`${getApiBaseUrl()}/admin/categories/${encodeURIComponent(categoryPath)}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.detail || 'Delete category failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert('空分類刪除成功！備份已保存至: ' + data.backup_location);
                refreshToolsList();
            })
            .catch(error => {
                console.error('Error deleting category:', error);
                alert(`刪除分類失敗: ${error.message}`);
            });
        }

        // ========== 圖片管理功能 ==========
        function loadExistingImages() {
            if (!currentEditingToolPath) return;
            
            const container = $('#existingImages');
            container.html(`
                <div class="text-muted text-center py-3">
                    <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                    <p>載入圖片中...</p>
                </div>
            `);
            
            fetch(`${getApiBaseUrl()}/admin/tool-images/${encodeURIComponent(currentEditingToolPath)}`, {
                headers: getAuthHeaders()
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load images');
                }
                return response.json();
            })
            .then(data => {
                displayExistingImages(data.images || []);
            })
            .catch(error => {
                console.error('Error loading images:', error);
                container.html(`
                    <div class="text-muted text-center py-3">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>載入圖片失敗</p>
                    </div>
                `);
            });
        }

        function displayExistingImages(images) {
            const container = $('#existingImages');
            
            if (images.length === 0) {
                container.html(`
                    <div class="text-muted text-center py-3">
                        <i class="fas fa-image fa-2x mb-2"></i>
                        <p>暫無圖片</p>
                    </div>
                `);
                return;
            }
            
            let html = '';
            images.forEach(image => {
                const imageUrl = `${getApiBaseUrl()}/gettoolimage/${encodeURIComponent(currentEditingToolPath)}/${encodeURIComponent(image.name)}`;
                html += `
                    <div class="image-item">
                        <img src="${imageUrl}" alt="${image.name}" onclick="insertImageToEditor('${image.name}')">
                        <div class="image-actions">
                            <button class="btn btn-sm btn-danger" onclick="deleteImage('${image.name}')" title="刪除圖片">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="image-name">${image.name}</div>
                    </div>
                `;
            });
            
            container.html(html);
        }

        function uploadImages() {
            const fileInput = document.getElementById('imageUpload');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('請選擇要上傳的圖片');
                return;
            }
            
            if (!currentEditingToolPath) {
                alert('沒有選擇要編輯的工具');
                return;
            }
            
            // Show progress
            const progressContainer = $('.image-upload-progress');
            progressContainer.show();
            const progressBar = progressContainer.find('.progress-bar');
            progressBar.css('width', '0%');
            
            // Upload files one by one
            uploadNextFile(0, files, progressBar, () => {
                // All files uploaded, reload images
                loadExistingImages();
                fileInput.value = ''; // Clear file input
                progressContainer.hide();
            });
        }

        function uploadNextFile(index, files, progressBar, onComplete) {
            if (index >= files.length) {
                onComplete();
                return;
            }
            
            const file = files[index];
            const formData = new FormData();
            formData.append('file', file);
            
            // Get token and prepare headers
            const token = localStorage.getItem('access_token');
            if (!token) {
                alert('認證token不存在，請重新登入');
                logout();
                return;
            }
            
            fetch(`${getApiBaseUrl()}/admin/upload-tool-image/${encodeURIComponent(currentEditingToolPath)}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                    // 注意：不要設置 Content-Type，讓瀏覽器自動設置 multipart/form-data
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.detail || 'Upload failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Update progress
                const progress = ((index + 1) / files.length) * 100;
                progressBar.css('width', progress + '%');
                progressBar.parent().prev().find('small:last-child').text(Math.round(progress) + '%');
                
                // Upload next file
                uploadNextFile(index + 1, files, progressBar, onComplete);
            })
            .catch(error => {
                console.error('Error uploading file:', error);
                alert(`上傳 ${file.name} 失敗: ${error.message}`);
                
                // Continue with next file
                uploadNextFile(index + 1, files, progressBar, onComplete);
            });
        }

        function deleteImage(imageName) {
            if (!confirm(`確定要刪除圖片 "${imageName}" 嗎？`)) {
                return;
            }
            
            fetch(`${getApiBaseUrl()}/admin/tool-images/${encodeURIComponent(currentEditingToolPath)}/${encodeURIComponent(imageName)}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.detail || 'Delete failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert('圖片刪除成功！');
                loadExistingImages();
            })
            .catch(error => {
                console.error('Error deleting image:', error);
                alert(`刪除圖片失敗: ${error.message}`);
            });
        }

        function insertImageToEditor(imageName) {
            const textarea = $('#editToolTextarea')[0];
            const markdownTag = `![圖片說明](./image/${imageName})`;
            
            // Insert at cursor position
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const currentValue = textarea.value;
            
            textarea.value = currentValue.substring(0, start) + markdownTag + currentValue.substring(end);
            
            // Set cursor position after the inserted text
            textarea.selectionStart = textarea.selectionEnd = start + markdownTag.length;
            
            // Focus back to textarea
            textarea.focus();
            
            // Trigger input event to update preview
            $(textarea).trigger('input');
        }

        function editTool(toolPath) {
            // Load tool content for editing
            currentEditingToolPath = toolPath;
            
            fetch(`${getApiBaseUrl()}/gettool/${encodeURIComponent(toolPath)}`, {
                headers: getAuthHeaders()
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load tool content');
                }
                return response.json();
            })
            .then(data => {
                currentEditingToolContent = data.content;
                hasUnsavedChanges = false;
                
                // Set modal title
                $('#editToolModal .modal-title').html(`<i class="fas fa-edit"></i> 編輯工具: ${escapeHtml(toolPath)}`);
                
                // Set textarea content
                $('#editToolTextarea').val(data.content);
                
                // Update preview and stats
                updateToolPreview();
                updateTextStats();
                
                // Setup real-time preview update and stats
                $('#editToolTextarea').off('input').on('input', function() {
                    updateToolPreview();
                    updateTextStats();
                    hasUnsavedChanges = ($(this).val() !== currentEditingToolContent);
                });
                
                // Setup keyboard shortcuts
                $('#editToolTextarea').off('keydown.shortcuts').on('keydown.shortcuts', function(e) {
                    // Ctrl+S to save
                    if (e.ctrlKey && e.key === 's') {
                        e.preventDefault();
                        saveToolContent();
                        return false;
                    }
                    
                    // Tab key support for indentation
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        const start = this.selectionStart;
                        const end = this.selectionEnd;
                        const value = this.value;
                        
                        if (e.shiftKey) {
                            // Shift+Tab: Remove indentation
                            const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                            const lineEnd = value.indexOf('\n', start);
                            const currentLine = value.substring(lineStart, lineEnd === -1 ? value.length : lineEnd);
                            
                            if (currentLine.startsWith('    ')) {
                                // Remove 4 spaces
                                this.value = value.substring(0, lineStart) + currentLine.substring(4) + value.substring(lineEnd === -1 ? value.length : lineEnd);
                                this.selectionStart = this.selectionEnd = start - 4;
                            } else if (currentLine.startsWith('\t')) {
                                // Remove tab
                                this.value = value.substring(0, lineStart) + currentLine.substring(1) + value.substring(lineEnd === -1 ? value.length : lineEnd);
                                this.selectionStart = this.selectionEnd = start - 1;
                            }
                        } else {
                            // Tab: Add indentation
                            this.value = value.substring(0, start) + '    ' + value.substring(end);
                            this.selectionStart = this.selectionEnd = start + 4;
                        }
                        
                        // Trigger input event to update preview
                        $(this).trigger('input');
                        return false;
                    }
                });
                
                // Setup scroll synchronization
                setupScrollSync();
                
                // Show modal and load images
                editToolModalInstance.show();
                
                // Load existing images
                loadExistingImages();
            })
            .catch(error => {
                console.error('Error loading tool for editing:', error);
                alert(`載入工具內容失敗: ${error.message}`);
            });
        }

        function updateTextStats() {
            const content = $('#editToolTextarea').val();
            const charCount = content.length;
            const lineCount = content.split('\n').length;
            
            $('#charCount').text(charCount.toLocaleString());
            $('#lineCount').text(lineCount.toLocaleString());
        }

        function setupScrollSync() {
            const textarea = $('#editToolTextarea')[0];
            const preview = $('#editToolPreviewContainer')[0];
            let isScrollingTextarea = false;
            let isScrollingPreview = false;

            // Sync scroll from textarea to preview
            $(textarea).off('scroll.sync').on('scroll.sync', function() {
                if (isScrollingPreview) return;
                isScrollingTextarea = true;
                
                const scrollPercentage = textarea.scrollTop / (textarea.scrollHeight - textarea.clientHeight);
                const targetScrollTop = scrollPercentage * (preview.scrollHeight - preview.clientHeight);
                preview.scrollTop = targetScrollTop;
                
                setTimeout(() => { isScrollingTextarea = false; }, 100);
            });

            // Sync scroll from preview to textarea
            $(preview).off('scroll.sync').on('scroll.sync', function() {
                if (isScrollingTextarea) return;
                isScrollingPreview = true;
                
                const scrollPercentage = preview.scrollTop / (preview.scrollHeight - preview.clientHeight);
                const targetScrollTop = scrollPercentage * (textarea.scrollHeight - textarea.clientHeight);
                textarea.scrollTop = targetScrollTop;
                
                setTimeout(() => { isScrollingPreview = false; }, 100);
            });
        }

        function updateToolPreview() {
            const content = $('#editToolTextarea').val();
            let htmlContent = marked.parse(content);
            
            // Replace image paths with API endpoints
            htmlContent = htmlContent.replace(
                /src="\.\/image\/([^"]+)"/g, 
                function(match, imageName) {
                    const cleanImageName = imageName.replace(/^[\.\/]+/, '');
                    const imageUrl = `${getApiBaseUrl()}/gettoolimage/${encodeURIComponent(currentEditingToolPath)}/${encodeURIComponent(cleanImageName)}`;
                    return `src="${imageUrl}"`;
                }
            );
            
            // Add loading for images
            htmlContent = htmlContent.replace(/<img/g, '<img loading="lazy"');
            
            $('#editToolPreview').html(htmlContent);
            
            // Re-setup scroll sync after content change
            setTimeout(setupScrollSync, 100);
        }

        function saveToolContent() {
            const content = $('#editToolTextarea').val();
            
            if (!currentEditingToolPath) {
                alert('沒有選擇要編輯的工具');
                return;
            }
            
            // Show saving indicator
            const saveBtn = $('#saveToolBtn');
            const originalText = saveBtn.html();
            saveBtn.html('<i class="fas fa-spinner fa-spin"></i> 儲存中...').prop('disabled', true);
            
            fetch(`${getApiBaseUrl()}/edittool/${encodeURIComponent(currentEditingToolPath)}`, {
                method: 'PUT',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    content: content
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.detail || 'Save failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Update current content
                currentEditingToolContent = content;
                hasUnsavedChanges = false;
                
                // Close modal
                editToolModalInstance.hide();
                
                alert('工具內容儲存成功！');
                
                // Refresh tools list if needed
                refreshToolsList();
            })
            .catch(error => {
                console.error('Save error:', error);
                if (error.message.includes('403')) {
                    alert('沒有編輯權限');
                } else if (error.message.includes('401')) {
                    alert('登入已過期，請重新登入');
                    logout();
                } else {
                    alert('儲存失敗：' + error.message);
                }
            })
            .finally(() => {
                saveBtn.html(originalText).prop('disabled', false);
            });
        }

        function cancelToolEdit() {
            if (hasUnsavedChanges) {
                if (confirm('確定要取消編輯嗎？未儲存的變更將會丟失。')) {
                    editToolModalInstance.hide();
                    hasUnsavedChanges = false;
                }
            } else {
                editToolModalInstance.hide();
            }
        }

        // Add event listener for search input
        $(document).ready(function() {
            $('#toolsSearch').on('keypress', function(e) {
                if (e.which === 13) { // Enter key
                    searchTools();
                }
            });

            // Initialize tools data on page load since tools tab is now default
            loadToolsData('');

            // Initialize tools tab when clicked (for when switching back)
            $('#tools-tab').on('click', function() {
                if (currentToolsList.length === 0) {
                    loadToolsData('');
                }
            });

            // Prevent closing edit modal if there are unsaved changes
            $('#editToolModal').on('hide.bs.modal', function(e) {
                if (hasUnsavedChanges) {
                    if (!confirm('確定要關閉編輯器嗎？未儲存的變更將會丟失。')) {
                        e.preventDefault();
                        return false;
                    }
                }
                hasUnsavedChanges = false;
                // Clean up event listeners
                $('#editToolTextarea').off('scroll.sync keydown.shortcuts');
                $('#editToolPreviewContainer').off('scroll.sync');
            });

            // Global keyboard shortcuts for edit modal
            $(document).on('keydown', function(e) {
                // Only when edit modal is open
                if ($('#editToolModal').hasClass('show')) {
                    // Esc key to cancel edit (with confirmation if unsaved changes)
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelToolEdit();
                        return false;
                    }
                }
            });
        });

        function validateEditPassword() {
            const password = $('#editPassword').val();
            const passwordConfirm = $('#editPasswordConfirm').val();
            
            // Reset validation states
            $('#editPassword, #editPasswordConfirm').removeClass('is-invalid is-valid');
            $('#editPasswordError').text('');
            
            if (password || passwordConfirm) {
                if (password.length > 0 && password.length < 6) {
                    $('#editPassword').addClass('is-invalid');
                    $('#editPasswordError').text('密碼長度至少需要6個字符');
                } else if (password.length >= 6) {
                    $('#editPassword').addClass('is-valid');
                }
                
                if (passwordConfirm.length > 0) {
                    if (password === passwordConfirm && password.length >= 6) {
                        $('#editPasswordConfirm').addClass('is-valid');
                    } else if (password !== passwordConfirm) {
                        $('#editPasswordConfirm').addClass('is-invalid');
                        $('#editPasswordError').text('密碼和確認密碼不匹配');
                    }
                }
            }
        }

        // Add event listeners when document is ready
        $(document).ready(function() {
            // Metadata editor change tracking
            if (document.getElementById('editMetadataTextarea')) {
                document.getElementById('editMetadataTextarea').addEventListener('input', function() {
                    hasUnsavedMetadataChanges = true;
                    updateMetadataUI();
                });

                // Keyboard shortcuts for metadata editor
                document.getElementById('editMetadataTextarea').addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.key === 's') {
                        e.preventDefault();
                        saveMetadata();
                    }
                    if (e.key === 'Escape') {
                        if (hasUnsavedMetadataChanges) {
                            if (confirm('有未儲存的變更，確定要離開嗎？')) {
                                editMetadataModalInstance.hide();
                            }
                        } else {
                            editMetadataModalInstance.hide();
                        }
                    }
                });
            }

            // Prevent accidental page close when editing metadata
            window.addEventListener('beforeunload', function (e) {
                if (hasUnsavedMetadataChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            // Handle metadata modal close
            if (editMetadataModalInstance) {
                document.getElementById('editMetadataModal').addEventListener('hide.bs.modal', function (e) {
                    if (hasUnsavedMetadataChanges) {
                        if (!confirm('有未儲存的變更，確定要關閉嗎？')) {
                            e.preventDefault();
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
