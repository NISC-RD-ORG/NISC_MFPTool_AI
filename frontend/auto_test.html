<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå‹•ç™»éŒ„å’Œæ¸¬è©¦</title>
    <script src="config.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .list-item { padding: 10px; border: 1px solid #ddd; margin: 5px 0; cursor: pointer; }
        .list-item:hover { background-color: #f8f9fa; }
        .list-item.category { background-color: #e7f3ff; }
        .list-item.tool { background-color: #fff3cd; }
        #listContainer { margin-top: 20px; }
        #navigationContainer { 
            margin-bottom: 20px; 
            padding: 10px; 
            background-color: #f8f9fa; 
            border-radius: 5px; 
        }
        #breadcrumbsContainer { 
            margin-bottom: 10px; 
            font-size: 14px; 
        }
        #backButtonContainer button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        #backButtonContainer button:hover {
            background-color: #5a6268;
        }
        .browse-input-container {
            margin: 10px 0;
        }
        .browse-input-container input {
            margin-right: 10px;
            padding: 5px;
        }
        .browse-input-container button {
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .browse-input-container button:hover {
            background-color: #0056b3;
        }
        .browse-input-container button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>è‡ªå‹•ç™»éŒ„å’Œå·¥å…·åˆ—è¡¨æ¸¬è©¦</h1>
    
    <div id="step1" class="step info">
        <h3>æ­¥é©Ÿ 1: ç™»éŒ„</h3>
        <button id="loginBtn">è‡ªå‹•ç™»éŒ„</button>
        <div id="loginResult"></div>
    </div>
    
    <div id="step2" class="step info">
        <h3>æ­¥é©Ÿ 2: æ¸¬è©¦æ–°ç‰ˆå‹•æ…‹ç€è¦½ API</h3>
        <button id="testBrowseBtn" disabled>æ¸¬è©¦å‹•æ…‹ç€è¦½ API</button>
        <div class="browse-input-container">
            <label>ç€è¦½è·¯å¾‘: </label>
            <input type="text" id="browsePath" placeholder="ä¾‹å¦‚: TaskalfaC3253 æˆ– TaskalfaC3253/4-10å®šæœŸä¿é¤Šæ­¥é©Ÿ" style="width: 400px;">
            <button id="browseBtn" disabled>ç€è¦½æŒ‡å®šè·¯å¾‘</button>
        </div>
        <div id="browseResult"></div>
    </div>
    
    <div id="step3" class="step info">
        <h3>æ­¥é©Ÿ 3: æ¸¬è©¦å‰ç«¯é¡¯ç¤º</h3>
        <button id="testDisplayBtn" disabled>æ¸¬è©¦ displayMixedList</button>
        <div id="navigationContainer">
            <div id="breadcrumbsContainer"></div>
            <div id="backButtonContainer"></div>
        </div>
        <div id="listContainer"></div>
    </div>

    <script>
        let apiData = null;
        let currentPath = '';

        function getIconForType(type) {
            switch(type) {
                case 'category': return 'fas fa-folder';
                case 'tool': return 'fas fa-wrench';
                default: return 'fas fa-file';
            }
        }

        function handleItemClick(item, type) {
            if (type === 'category') {
                // Navigate to subcategory
                currentPath = item.path;
                loadPath(item.path);
            } else {
                alert(`é»æ“Šäº†å·¥å…·: ${item.display_name || item.name}`);
            }
        }

        function displayBreadcrumbs(breadcrumbs, parentPath) {
            const breadcrumbsContainer = $('#breadcrumbsContainer');
            const backButtonContainer = $('#backButtonContainer');
            
            breadcrumbsContainer.empty();
            backButtonContainer.empty();
            
            // Add home/root link
            const homeLink = $(`<a href="#" style="margin-right: 10px; color: #007bff; text-decoration: none;">ğŸ  æ ¹ç›®éŒ„</a>`);
            homeLink.on('click', (e) => {
                e.preventDefault();
                currentPath = '';
                loadPath('');
            });
            breadcrumbsContainer.append(homeLink);
            
            // Add breadcrumb links
            if (breadcrumbs && breadcrumbs.length > 0) {
                breadcrumbs.forEach((crumb, index) => {
                    breadcrumbsContainer.append(' > ');
                    const crumbLink = $(`<a href="#" style="margin-right: 5px; color: #007bff; text-decoration: none;">${crumb.display_name}</a>`);
                    crumbLink.on('click', (e) => {
                        e.preventDefault();
                        currentPath = crumb.path;
                        loadPath(crumb.path);
                    });
                    breadcrumbsContainer.append(crumbLink);
                });
            }
            
            // Add back button if not at root
            if (parentPath !== null) {
                const backBtn = $(`<button style="margin-top: 10px;">â† è¿”å›ä¸Šä¸€å±¤</button>`);
                backBtn.on('click', () => {
                    currentPath = parentPath;
                    loadPath(parentPath);
                });
                backButtonContainer.append(backBtn);
            }
        }

        async function loadPath(path) {
            try {
                const token = localStorage.getItem('access_token');
                
                const url = path ? 
                    `${getApiBaseUrl()}/browse?path=${encodeURIComponent(path)}` : 
                    `${getApiBaseUrl()}/browse`;
                
                console.log('èª¿ç”¨ Browse API:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('Browse API å›æ‡‰:', data);
                
                if (response.ok) {
                    apiData = data;
                    displayBreadcrumbs(data.breadcrumbs, data.parent_path);
                    displayMixedList(data.items || []);
                    
                    $('#browseResult').html(
                        `<p style="color: green;">âœ“ ç€è¦½æˆåŠŸï¼è·¯å¾‘: ${path || 'æ ¹ç›®éŒ„'}</p>` +
                        `<p>Items æ•¸é‡: ${data.items ? data.items.length : 0}</p>` +
                        `<p>API URL: ${url}</p>`
                    );
                    $('#step2').removeClass('info error').addClass('success');
                } else {
                    $('#browseResult').html(
                        `<p style="color: red;">âœ— ç€è¦½å¤±æ•—: ${JSON.stringify(data)}</p>`
                    );
                    $('#step2').removeClass('info success').addClass('error');
                }
                
            } catch (error) {
                $('#browseResult').html(
                    `<p style="color: red;">âœ— ç€è¦½éŒ¯èª¤: ${error.message}</p>`
                );
                $('#step2').removeClass('info success').addClass('error');
                console.error('Browse error:', error);
            }
        }

        function displayMixedList(items) {
            const listContainer = $('#listContainer');
            listContainer.empty();
            
            console.log('=== displayMixedList æ¸¬è©¦é–‹å§‹ ===');
            console.log('Parameters:', { items });
            console.log('Items é¡å‹:', typeof items, 'æ˜¯æ•¸çµ„:', Array.isArray(items));
            console.log('Items é•·åº¦:', items ? items.length : 'null/undefined');
            
            if (items && Array.isArray(items)) {
                console.log('>>> ä½¿ç”¨ items æ•¸çµ„è·¯å¾‘ <<<');
                console.log('Items æ•¸çµ„é•·åº¦:', items.length);
                
                if (items.length === 0) {
                    console.log('Items æ•¸çµ„ç‚ºç©ºï¼Œé¡¯ç¤ºç„¡é …ç›®æ¶ˆæ¯');
                    listContainer.append(`<li class="error">æ²’æœ‰æ‰¾åˆ°é …ç›®</li>`);
                } else {
                    console.log('è™•ç†', items.length, 'å€‹é …ç›®:');
                    items.forEach((item, index) => {
                        console.log(`è™•ç†é …ç›® ${index}:`, item);
                        const itemType = item.type || (item.is_tool ? 'tool' : 'category');
                        const icon = getIconForType(itemType);
                        const toolCount = item.tool_count ? ` (${item.tool_count} å·¥å…·)` : '';
                        
                        console.log(`å‰µå»ºåˆ—è¡¨é …ç›®: ${item.name}, é¡å‹: ${itemType}`);
                        
                        const listItem = $(`
                            <li class="list-item ${itemType}" data-name="${item.name}" data-type="${itemType}">
                                <i class="${icon}"></i> ${item.display_name || item.name}${toolCount}
                            </li>
                        `);
                        
                        listItem.on('click', function() {
                            handleItemClick(item, itemType);
                        });
                        
                        listContainer.append(listItem);
                        console.log(`é …ç›® ${index} å·²æ·»åŠ åˆ°å®¹å™¨`);
                    });
                }
                
                console.log('æœ€çµ‚å®¹å™¨å­å…ƒç´ æ•¸é‡:', listContainer.children().length);
            } else {
                console.log('No items array found');
                listContainer.append(`<li class="error">æ²’æœ‰æ‰¾åˆ°é …ç›®</li>`);
            }
            
            console.log('=== displayMixedList æ¸¬è©¦çµæŸ ===');
        }

        document.getElementById('loginBtn').onclick = async function() {
            try {
                const response = await fetch(`${getApiBaseUrl()}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account: 'admin',
                        password: 'nisc27978831'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('user_info', JSON.stringify(data.user));
                    
                    document.getElementById('loginResult').innerHTML = 
                        '<p style="color: green;">âœ“ ç™»éŒ„æˆåŠŸï¼</p>';
                    document.getElementById('step1').className = 'step success';
                    document.getElementById('testBrowseBtn').disabled = false;
                    document.getElementById('browseBtn').disabled = false;
                } else {
                    document.getElementById('loginResult').innerHTML = 
                        '<p style="color: red;">âœ— ç™»éŒ„å¤±æ•—: ' + JSON.stringify(data) + '</p>';
                    document.getElementById('step1').className = 'step error';
                }
            } catch (error) {
                document.getElementById('loginResult').innerHTML = 
                    '<p style="color: red;">âœ— ç™»éŒ„éŒ¯èª¤: ' + error.message + '</p>';
                document.getElementById('step1').className = 'step error';
            }
        };

        document.getElementById('testBrowseBtn').onclick = async function() {
            currentPath = 'TaskalfaC3253';
            await loadPath(currentPath);
            document.getElementById('step2').className = 'step success';
            document.getElementById('testDisplayBtn').disabled = false;
        };

        document.getElementById('browseBtn').onclick = async function() {
            const path = document.getElementById('browsePath').value.trim();
            currentPath = path;
            await loadPath(path);
            document.getElementById('step2').className = 'step success';
            document.getElementById('testDisplayBtn').disabled = false;
        };

        document.getElementById('testDisplayBtn').onclick = function() {
            if (apiData && apiData.items) {
                console.log('é–‹å§‹æ¸¬è©¦ displayMixedListï¼Œä½¿ç”¨ API æ•¸æ“š');
                displayMixedList(apiData.items);
                document.getElementById('step3').className = 'step success';
            } else {
                alert('è«‹å…ˆæˆåŠŸèª¿ç”¨ç€è¦½ APIï¼');
            }
        };
    </script>
</body>
</html>
