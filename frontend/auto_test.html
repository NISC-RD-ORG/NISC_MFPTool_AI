<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自動登錄和測試</title>
    <script src="config.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .list-item { padding: 10px; border: 1px solid #ddd; margin: 5px 0; cursor: pointer; }
        .list-item:hover { background-color: #f8f9fa; }
        .list-item.category { background-color: #e7f3ff; }
        .list-item.tool { background-color: #fff3cd; }
        #listContainer { margin-top: 20px; }
        #navigationContainer { 
            margin-bottom: 20px; 
            padding: 10px; 
            background-color: #f8f9fa; 
            border-radius: 5px; 
        }
        #breadcrumbsContainer { 
            margin-bottom: 10px; 
            font-size: 14px; 
        }
        #backButtonContainer button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        #backButtonContainer button:hover {
            background-color: #5a6268;
        }
        .browse-input-container {
            margin: 10px 0;
        }
        .browse-input-container input {
            margin-right: 10px;
            padding: 5px;
        }
        .browse-input-container button {
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .browse-input-container button:hover {
            background-color: #0056b3;
        }
        .browse-input-container button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>自動登錄和工具列表測試</h1>
    
    <div id="step1" class="step info">
        <h3>步驟 1: 登錄</h3>
        <button id="loginBtn">自動登錄</button>
        <div id="loginResult"></div>
    </div>
    
    <div id="step2" class="step info">
        <h3>步驟 2: 測試新版動態瀏覽 API</h3>
        <button id="testBrowseBtn" disabled>測試動態瀏覽 API</button>
        <div class="browse-input-container">
            <label>瀏覽路徑: </label>
            <input type="text" id="browsePath" placeholder="例如: TaskalfaC3253 或 TaskalfaC3253/4-10定期保養步驟" style="width: 400px;">
            <button id="browseBtn" disabled>瀏覽指定路徑</button>
        </div>
        <div id="browseResult"></div>
    </div>
    
    <div id="step3" class="step info">
        <h3>步驟 3: 測試前端顯示</h3>
        <button id="testDisplayBtn" disabled>測試 displayMixedList</button>
        <div id="navigationContainer">
            <div id="breadcrumbsContainer"></div>
            <div id="backButtonContainer"></div>
        </div>
        <div id="listContainer"></div>
    </div>

    <script>
        let apiData = null;
        let currentPath = '';

        function getIconForType(type) {
            switch(type) {
                case 'category': return 'fas fa-folder';
                case 'tool': return 'fas fa-wrench';
                default: return 'fas fa-file';
            }
        }

        function handleItemClick(item, type) {
            if (type === 'category') {
                // Navigate to subcategory
                currentPath = item.path;
                loadPath(item.path);
            } else {
                alert(`點擊了工具: ${item.display_name || item.name}`);
            }
        }

        function displayBreadcrumbs(breadcrumbs, parentPath) {
            const breadcrumbsContainer = $('#breadcrumbsContainer');
            const backButtonContainer = $('#backButtonContainer');
            
            breadcrumbsContainer.empty();
            backButtonContainer.empty();
            
            // Add home/root link
            const homeLink = $(`<a href="#" style="margin-right: 10px; color: #007bff; text-decoration: none;">🏠 根目錄</a>`);
            homeLink.on('click', (e) => {
                e.preventDefault();
                currentPath = '';
                loadPath('');
            });
            breadcrumbsContainer.append(homeLink);
            
            // Add breadcrumb links
            if (breadcrumbs && breadcrumbs.length > 0) {
                breadcrumbs.forEach((crumb, index) => {
                    breadcrumbsContainer.append(' > ');
                    const crumbLink = $(`<a href="#" style="margin-right: 5px; color: #007bff; text-decoration: none;">${crumb.display_name}</a>`);
                    crumbLink.on('click', (e) => {
                        e.preventDefault();
                        currentPath = crumb.path;
                        loadPath(crumb.path);
                    });
                    breadcrumbsContainer.append(crumbLink);
                });
            }
            
            // Add back button if not at root
            if (parentPath !== null) {
                const backBtn = $(`<button style="margin-top: 10px;">← 返回上一層</button>`);
                backBtn.on('click', () => {
                    currentPath = parentPath;
                    loadPath(parentPath);
                });
                backButtonContainer.append(backBtn);
            }
        }

        async function loadPath(path) {
            try {
                const token = localStorage.getItem('access_token');
                
                const url = path ? 
                    `${getApiBaseUrl()}/browse?path=${encodeURIComponent(path)}` : 
                    `${getApiBaseUrl()}/browse`;
                
                console.log('調用 Browse API:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('Browse API 回應:', data);
                
                if (response.ok) {
                    apiData = data;
                    displayBreadcrumbs(data.breadcrumbs, data.parent_path);
                    displayMixedList(data.items || []);
                    
                    $('#browseResult').html(
                        `<p style="color: green;">✓ 瀏覽成功！路徑: ${path || '根目錄'}</p>` +
                        `<p>Items 數量: ${data.items ? data.items.length : 0}</p>` +
                        `<p>API URL: ${url}</p>`
                    );
                    $('#step2').removeClass('info error').addClass('success');
                } else {
                    $('#browseResult').html(
                        `<p style="color: red;">✗ 瀏覽失敗: ${JSON.stringify(data)}</p>`
                    );
                    $('#step2').removeClass('info success').addClass('error');
                }
                
            } catch (error) {
                $('#browseResult').html(
                    `<p style="color: red;">✗ 瀏覽錯誤: ${error.message}</p>`
                );
                $('#step2').removeClass('info success').addClass('error');
                console.error('Browse error:', error);
            }
        }

        function displayMixedList(items) {
            const listContainer = $('#listContainer');
            listContainer.empty();
            
            console.log('=== displayMixedList 測試開始 ===');
            console.log('Parameters:', { items });
            console.log('Items 類型:', typeof items, '是數組:', Array.isArray(items));
            console.log('Items 長度:', items ? items.length : 'null/undefined');
            
            if (items && Array.isArray(items)) {
                console.log('>>> 使用 items 數組路徑 <<<');
                console.log('Items 數組長度:', items.length);
                
                if (items.length === 0) {
                    console.log('Items 數組為空，顯示無項目消息');
                    listContainer.append(`<li class="error">沒有找到項目</li>`);
                } else {
                    console.log('處理', items.length, '個項目:');
                    items.forEach((item, index) => {
                        console.log(`處理項目 ${index}:`, item);
                        const itemType = item.type || (item.is_tool ? 'tool' : 'category');
                        const icon = getIconForType(itemType);
                        const toolCount = item.tool_count ? ` (${item.tool_count} 工具)` : '';
                        
                        console.log(`創建列表項目: ${item.name}, 類型: ${itemType}`);
                        
                        const listItem = $(`
                            <li class="list-item ${itemType}" data-name="${item.name}" data-type="${itemType}">
                                <i class="${icon}"></i> ${item.display_name || item.name}${toolCount}
                            </li>
                        `);
                        
                        listItem.on('click', function() {
                            handleItemClick(item, itemType);
                        });
                        
                        listContainer.append(listItem);
                        console.log(`項目 ${index} 已添加到容器`);
                    });
                }
                
                console.log('最終容器子元素數量:', listContainer.children().length);
            } else {
                console.log('No items array found');
                listContainer.append(`<li class="error">沒有找到項目</li>`);
            }
            
            console.log('=== displayMixedList 測試結束 ===');
        }

        document.getElementById('loginBtn').onclick = async function() {
            try {
                const response = await fetch(`${getApiBaseUrl()}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account: 'admin',
                        password: 'nisc27978831'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('user_info', JSON.stringify(data.user));
                    
                    document.getElementById('loginResult').innerHTML = 
                        '<p style="color: green;">✓ 登錄成功！</p>';
                    document.getElementById('step1').className = 'step success';
                    document.getElementById('testBrowseBtn').disabled = false;
                    document.getElementById('browseBtn').disabled = false;
                } else {
                    document.getElementById('loginResult').innerHTML = 
                        '<p style="color: red;">✗ 登錄失敗: ' + JSON.stringify(data) + '</p>';
                    document.getElementById('step1').className = 'step error';
                }
            } catch (error) {
                document.getElementById('loginResult').innerHTML = 
                    '<p style="color: red;">✗ 登錄錯誤: ' + error.message + '</p>';
                document.getElementById('step1').className = 'step error';
            }
        };

        document.getElementById('testBrowseBtn').onclick = async function() {
            currentPath = 'TaskalfaC3253';
            await loadPath(currentPath);
            document.getElementById('step2').className = 'step success';
            document.getElementById('testDisplayBtn').disabled = false;
        };

        document.getElementById('browseBtn').onclick = async function() {
            const path = document.getElementById('browsePath').value.trim();
            currentPath = path;
            await loadPath(path);
            document.getElementById('step2').className = 'step success';
            document.getElementById('testDisplayBtn').disabled = false;
        };

        document.getElementById('testDisplayBtn').onclick = function() {
            if (apiData && apiData.items) {
                console.log('開始測試 displayMixedList，使用 API 數據');
                displayMixedList(apiData.items);
                document.getElementById('step3').className = 'step success';
            } else {
                alert('請先成功調用瀏覽 API！');
            }
        };
    </script>
</body>
</html>
